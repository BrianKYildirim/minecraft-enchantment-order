{% extends 'base.html' %}
{% block body %}
    <h1><a href=\"/\">Minecraft Enchant Planner</a></h1>
    <form id="planner-form" method="post" action="{{ url_for('calculate') }}">
        <h2>1. Choose your item</h2>
        <select id="item-select" name="item_type" required>
            <option value="" disabled selected>-- pick item --</option>
            {% for it in items %}
                <option value="{{ it }}">{{ it|replace('_',' ')|title }}</option>{% endfor %}
        </select>

        <!-- blocks are injected dynamically -->
        <div id="dynamic-area"></div>

        <div id="mode-block" style="display:none;margin-top:1rem;">
            <h2>4. Optimize for…</h2>
            <label><input type="radio" name="mode" value="levels" checked> Least total levels</label>
            <label><input type="radio" name="mode" value="prior_work"> Least prior‑work penalty</label>
            <p>
                <button type="submit">Calculate&nbsp;Plan</button>
            </p>
        </div>
    </form>

    <!-- result injected here -->
    <div id="result-block" style="display:none;margin-top:2rem;"></div>

    <style>
        .strip0 { background:#fff; }
        .strip1 { background: #d4d4d4; }
        .group-title {
            font-weight: bold;
            background: #f0f0f0;
            padding: 2px 4px;
            margin-top: 0.5rem;
        }

        .ench-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0px 0;
            padding:2px 0;
        }
        .ench-row.disabled-row { opacity:.4; }

        .level-btn { padding:2px 6px; border:1px solid #666; background:#fafafa; cursor:pointer }
        .level-btn.selected { background:#8cf }
        .level-btn:disabled { opacity:.3; cursor:not-allowed }

        .disabled-row {
            opacity: 0.4;
        }
    </style>

    <script>
        const ENCHANTS = {{ enchants|tojson }};   // list of [namespace, meta]

        function prettify(ns) {
            return ns.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        const form = document.getElementById('planner-form');
        const itemSel = document.getElementById('item-select');
        const dyn = document.getElementById('dynamic-area');
        const modeBlock = document.getElementById('mode-block');
        const resultBlock = document.getElementById('result-block');

        let curInputs = {}, desInputs = {}; // map ns -> hidden input element

        itemSel.addEventListener('change', () => {
            buildTables(itemSel.value);
        });

        function buildTables(item) {
            dyn.innerHTML = '';
            resultBlock.style.display = 'none';
            if (!item) {
                modeBlock.style.display = 'none';
                return;
            }

            // filter applicable enchants
            const applicable = ENCHANTS.filter(([ns, meta]) => meta.items.includes(item));

            // create incompatibility graph and groups
            const remaining = new Set(applicable.map(([ns]) => ns));
            const groups = [];
            while (remaining.size) {
                const ns = [...remaining][0];
                const group = new Set();
                const queue = [ns];
                while (queue.length) {
                    const x = queue.pop();
                    if (!remaining.has(x)) continue;
                    remaining.delete(x);
                    group.add(x);
                    const inc = ENCHANTS.find(([n]) => n === x)[1].incompatible;
                    inc.forEach(y => {
                        if (remaining.has(y)) queue.push(y);
                    });
                }
                groups.push([...group]);
            }

            // build two sections (current & desired)
            ['cur', 'des'].forEach(section => {
                const block = document.createElement('div');
                block.id = section + '-block';
                block.innerHTML = `<h2 style="display:flex;align-items:center;gap:.5rem">
                    ${section === 'cur'
                    ? '2. Current enchantments on that item'
                    : '3. Desired final enchantments'}${section === 'cur'
                    ? '<label style="font-weight:400;margin-left:auto">Prior Work Penalty: <input type="number" name="prior_work" min="0" max="39" value="0" style="width:4rem"></label>'
                    : ''}</h2>`;

                let stripe=0;                       // 0 = light, 1 = dark
                groups.forEach(g=>{
                    g.forEach(ns=>{
                        const meta=ENCHANTS.find(([n])=>n===ns)[1];
                        const row=document.createElement('div');
                        row.className=`ench-row strip${stripe}`;
                        row.dataset.ns=ns;
                        row.dataset.incompat=meta.incompatible.join(',');
                        row.innerHTML=`<span style="width:160px">${prettify(ns)}</span>`;

                        /* hidden input */
                        const h=document.createElement('input');
                        h.type='hidden'; h.name=`${section}-${ns}`;
                        row.appendChild(h);
                        if(section==='cur') curInputs[ns]=h; else desInputs[ns]=h;

                        /* level buttons */
                        for(let lv=1;lv<=meta.levelMax;lv++){
                            const b=document.createElement('button');
                            b.type='button'; b.textContent=lv; b.className='level-btn'; b.dataset.level=lv;
                            b.addEventListener('click',()=>toggle(b,h,row));
                            row.appendChild(b);
                        }
                        block.appendChild(row);
                    });
                    stripe = 1 - stripe;
                });
                dyn.appendChild(block);
            });
            modeBlock.style.display = 'block';
        }

        function clearRow(row) {
            row.querySelectorAll('.level-btn.selected')
                .forEach(b => b.classList.remove('selected'));
            row.querySelector('input[type="hidden"]').value = '';
        }

        function toggle(btn, hidden, row) {
            // Same button again → clear
            if (btn.classList.contains('selected')) {
                clearRow(row);
                updateDisable();
                return;
            }

            // Choose this level
            clearRow(row);
            btn.classList.add('selected');
            hidden.value = btn.dataset.level;

            // Clear every incompatible row
            row.dataset.incompat.split(',').filter(Boolean).forEach(ns => {
                const r = document.querySelector(`.ench-row[data-ns=\"${ns}\"]`);
                if (r) clearRow(r);
            });

            updateDisable();
            updateDesiredLock();
        }

        function updateDisable() {
            const selectedNS = new Set();
            document.querySelectorAll('.ench-row').forEach(row => {
                const ns = row.dataset.ns;
                const active = row.querySelector('.level-btn.selected');
                if (active) selectedNS.add(ns);
            });
            const disableSet = new Set();
            selectedNS.forEach(ns => {
                const inc = document.querySelector(`.ench-row[data-ns='${ns}']`).dataset.incompat.split(',').filter(Boolean);
                inc.forEach(x => disableSet.add(x));
            });
            document.querySelectorAll('.ench-row').forEach(row => {
                const ns = row.dataset.ns;
                const isDisabled =
                    (disableSet.has(ns) ||
                        selectedNS.has(ns))
                    && !row.querySelector('.level-btn.selected');
                row.classList.toggle('disabled-row', isDisabled);
                row.querySelectorAll('.level-btn').forEach(btn => btn.disabled = isDisabled);
            });

            updateDesiredLock();
        }

        function updateDesiredLock() {
            /* collect every namespace that is currently selected anywhere */
            const selected = new Set(
                [...document.querySelectorAll('.level-btn.selected')]
                    .map(btn => btn.closest('.ench-row').dataset.ns)
            );

            /* everything incompatible with any selected ns */
            const blocked = new Set(selected);
            selected.forEach(ns => {
                const inc = document.querySelector(`.ench-row[data-ns='${ns}']`)
                    ?.dataset.incompat.split(',').filter(Boolean) || [];
                inc.forEach(x => blocked.add(x));
            });

            /* grey‑out+disable rows inside DES block, unless they themselves are chosen */
            document.querySelectorAll('#des-block .ench-row').forEach(row => {
                const ns = row.dataset.ns;
                const keep = row.querySelector('.level-btn.selected'); // chosen in Desired
                const off = blocked.has(ns) && !keep;
                row.classList.toggle('disabled-row', off);
                row.querySelectorAll('.level-btn').forEach(b => b.disabled = off);
            });
        }

        // Ajax submit to keep result on same page ---------------------------------
        form.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(form);
            fetch(form.action, {method: 'POST', body: formData})
                .then(r => r.text())
                .then(html => {
                    resultBlock.innerHTML = html;
                    resultBlock.style.display = 'block';
                    resultBlock.scrollIntoView({behavior: 'smooth'});
                })
                .catch(err => alert(err));
        });
    </script>
{% endblock %}