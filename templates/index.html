{% extends 'base.html' %}
{% block body %}

    <h1 class="text-center text-3xl font-extrabold text-brand mb-12">Minecraft Enchant Planner</h1>

    <form id="planner-form" method="post" action="{{ url_for('calculate') }}" class="flex flex-col gap-12">
        <!-- Item Picker -->
        <section class="flex flex-col gap-4 max-w-md mx-auto">
            <h2 class="text-lg font-semibold">1. Choose your item</h2>
            <label class="relative w-full">
                <select id="item-select" name="item_type"
                        class="peer w-full rounded-lg border border-slate-700 bg-slate-800/80 px-4 py-2 pr-10 text-sm text-slate-100 shadow focus:border-brand focus:ring-2 focus:ring-brand">
                    <option value="" disabled selected>— pick item —</option>
                    {% for it in items %}
                        <option value="{{ it }}">{{ it|replace('_',' ')|title }}</option>
                    {% endfor %}
                </select>
                <svg class="pointer-events-none absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400 peer-focus:text-brand"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </label>
        </section>

        <!-- Current & Desired Panels -->
        <div id="dynamic-area" class="grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-14"></div>

        <!-- Optimisation Mode -->
        <section id="mode-block" class="hidden flex flex-col gap-6">
            <h2 class="text-lg font-semibold">4. Optimize for…</h2>
            <div class="flex flex-wrap gap-6">
                <label class="inline-flex items-center gap-2"><input type="radio" name="mode" value="levels"
                                                                     class="accent-brand" checked>Least total
                    levels</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="mode" value="prior_work"
                                                                     class="accent-brand">Least prior-work
                    penalty</label>
            </div>
            <button type="submit"
                    class="self-start rounded-lg bg-brand px-6 py-2 font-semibold text-white shadow hover:bg-brand/90 focus:ring-2 focus:ring-brand transition">
                Calculate Plan
            </button>
        </section>
    </form>

    <div id="result-block" class="scroll-mt-24 space-y-8"></div>

    <style>
        /* Panel */
        .ench-container {
            background-color: #1e2535;
            border: 1px solid #334155;
            border-radius: .75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgb(0 0 0 / .25);
        }

        /* no max‑height => no scrollbar */
        .ench-container h3 {
            font-size: .875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Rows */
        .ench-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: .5rem 1rem;
        }

        .stripe-0 {
            background-color: #233047;
        }

        /* dark bluish */
        .stripe-1 {
            background-color: #1d283a;
        }

        /* slightly darker */
        .ench-row.disabled-row {
            opacity: .3;
            pointer-events: none;
            user-select: none;
        }

        .ench-name {
            width: 160px;
            font-weight: 500;
            font-size: .875rem;
            color: #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .level-cell {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
        }

        .level-btn {
            width: 2rem;
            height: 2rem;
            display: grid;
            place-content: center;
            border: 1px solid #475569;
            background-color: #0f172a;
            font-size: .75rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: .15s background-color;
        }

        .level-btn:hover {
            background-color: rgba(59, 130, 246, .25);
        }

        /* hover tint */
        .level-btn.selected {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        .level-btn:disabled {
            opacity: .25;
            cursor: not-allowed;
        }

        input[type=number] {
            width: 5rem;
            border: 1px solid #475569;
            border-radius: .375rem;
            background-color: #0f172a;
            color: #e2e8f0;
            padding: .25rem .5rem;
            text-align: center;
            font-size: .875rem;
        }
    </style>

    <script>
        const ENCHANTS = {{ enchants|tojson }};
        const NAMES = {{ pretty_names|tojson }}

        function prettify(ns) {
            return NAMES[ns] || ns;
        }

        const form = document.getElementById('planner-form');
        const itemSel = document.getElementById('item-select');
        const dyn = document.getElementById('dynamic-area');
        const modeBlk = document.getElementById('mode-block');
        const resBlk = document.getElementById('result-block');
        let curInputs = {}, desInputs = {};

        itemSel.addEventListener('change', () => buildTables(itemSel.value));

        function buildTables(item) {
            dyn.innerHTML = '';
            resBlk.style.display = 'none';
            if (!item) {
                modeBlk.classList.add('hidden');
                return;
            }

            const applicable = ENCHANTS.filter(([ns, m]) => m.items.includes(item));
            // 1) same BFS grouping, but only on non-curse enchants:
            const curses = ['curse_of_binding', 'curse_of_vanishing'];
            const nonCurses = applicable
                .map(([ns]) => ns)
                .filter(ns => !curses.includes(ns));

            const remaining = new Set(nonCurses);
            let groups = [];
            while (remaining.size) {
                const root = [...remaining][0];
                const queue = [root], group = new Set();
                while (queue.length) {
                    const x = queue.pop();
                    if (!remaining.has(x)) continue;
                    remaining.delete(x);
                    group.add(x);
                    ENCHANTS.find(([n]) => n === x)[1].incompatible
                        .forEach(i => remaining.has(i) && queue.push(i));
                }
                groups.push([...group]);
            }

            groups.sort((a, b) => b.length - a.length);

            curses.forEach(c => {
                if (applicable.some(([ns]) => ns === c)) {
                    groups.push([c]);
                }
            });

            [['cur', '2. Current enchantments'], ['des', '3. Desired final enchantments']].forEach(([key, title]) => {
                const wrap = document.createElement('div');
                wrap.className = 'ench-container';
                wrap.innerHTML = `<h3>${title}</h3>`;
                if (key === 'cur') wrap.innerHTML += `<label class="inline-flex items-center gap-2 mb-4 text-sm">Prior-work penalty: <input type="number" name="prior_work" min="0" max="39" value="0"></label>`;
                let stripe = 0; // alternate per incompat group
                groups.forEach(g => {
                    g.forEach(ns => {
                        const meta = ENCHANTS.find(([n]) => n === ns)[1];
                        const row = document.createElement('div');
                        row.className = `ench-row stripe-${stripe}`;
                        row.dataset.ns = ns;
                        row.dataset.incompat = meta.incompatible.join(',');
                        row.innerHTML = `<span class="ench-name">${prettify(ns)}</span><div class="level-cell"></div>`;
                        const cell = row.querySelector('.level-cell');
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = `${key}-${ns}`;
                        row.appendChild(hidden);
                        key === 'cur' ? curInputs[ns] = hidden : desInputs[ns] = hidden;
                        for (let lv = 1; lv <= meta.levelMax; lv++) {
                            const b = document.createElement('button');
                            b.type = 'button';
                            b.textContent = lv;
                            b.className = 'level-btn';
                            b.dataset.level = lv;
                            b.addEventListener('click', () => toggle(b, hidden, row));
                            cell.appendChild(b);
                        }
                        wrap.appendChild(row);
                    });
                    stripe = 1 - stripe; // switch colour for next incompat group
                });
                dyn.appendChild(wrap);
            });
            modeBlk.classList.remove('hidden');
        }

        function clearRow(r) {
            r.querySelectorAll('.level-btn.selected').forEach(b => b.classList.remove('selected'));
            r.querySelector('input[type="hidden"]').value = '';
        }

        function toggle(btn, hidden, row) {
            if (btn.classList.contains('selected')) {
                clearRow(row);
                updateDisable();
                return;
            }
            clearRow(row);
            btn.classList.add('selected');
            hidden.value = btn.dataset.level;
            row.dataset.incompat.split(',').filter(Boolean).forEach(ns => {
                const rr = document.querySelector(`.ench-row[data-ns="${ns}"]`);
                rr && clearRow(rr);
            });
            updateDisable();
            updateDesiredLock();
        }

        function updateDisable() {
            const sel = new Set([...document.querySelectorAll('.level-btn.selected')].map(b => b.closest('.ench-row').dataset.ns));
            const dis = new Set();
            sel.forEach(ns => ENCHANTS.find(([n]) => n === ns)[1].incompatible.forEach(i => dis.add(i)));
            document.querySelectorAll('.ench-row').forEach(r => {
                const ns = r.dataset.ns;
                const keep = r.querySelector('.level-btn.selected');
                const off = (dis.has(ns) || sel.has(ns)) && !keep;
                r.classList.toggle('disabled-row', off);
                r.querySelectorAll('.level-btn').forEach(b => b.disabled = off);
            });
        }

        function updateDesiredLock() {
            const sel = new Set([...document.querySelectorAll('.level-btn.selected')].map(b => b.closest('.ench-row').dataset.ns));
            const blk = new Set(sel);
            sel.forEach(ns => ENCHANTS.find(([n]) => n === ns)[1].incompatible.forEach(i => blk.add(i)));
            document.querySelectorAll('#dynamic-area > div:nth-child(2) .ench-row').forEach(r => {
                const ns = r.dataset.ns;
                const keep = r.querySelector('.level-btn.selected');
                const off = blk.has(ns) && !keep;
                r.classList.toggle('disabled-row', off);
                r.querySelectorAll('.level-btn').forEach(b => b.disabled = off);
            });
        }

        form.addEventListener('submit', e => {
            e.preventDefault();
            const fd = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: fd
            }).then(r => r.redirected ? window.location = r.url : r.text()).then(html => {
                if (!html) return;
                resBlk.innerHTML = html;
                resBlk.style.display = 'block';
                resBlk.scrollIntoView({behavior: 'smooth'});
            });
        });
    </script>

{% endblock %}